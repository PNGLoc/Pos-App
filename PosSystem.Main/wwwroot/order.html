<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chi ti·∫øt b√†n</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- ========== HEADER ========== -->
    <div class="header-order">
        <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
            <button onclick="goBackToTables()"
                style="background:none; border:none; color:white; font-size:24px; padding:5px;">‚¨Ö</button>
            <span id="table-name" style="font-weight:bold; font-size:16px;">B√†n ...</span>
        </div>
        <button id="btn-select-dish" onclick="openMenuModal()"
            style="background:#28a745; border:none; color:white; padding:8px 12px; border-radius:4px; font-weight:bold;">Ch·ªçn
            m√≥n</button>
    </div>

    <!-- ========== TAB NAVIGATION ========== -->
    <div class="tab-navigation">
        <div id="tab-ordered" class="tab-btn active" onclick="switchTab('ordered')">Th·ª±c ƒë∆°n ƒë√£ g·ªçi</div>
        <div id="tab-confirmed" class="tab-btn" onclick="switchTab('confirmed')">M√≥n ƒë√£ x√°c nh·∫≠n</div>
    </div>

    <!-- ========== TAB 1: TH·ª∞C ƒê∆†N ƒê√É G·ªåI (GI·ªé H√ÄNG) ========== -->
    <div id="panel-ordered" class="tab-panel active">
        <div id="ordered-items" style="padding: 15px; min-height: 200px;">
            <div class="empty-state">Ch∆∞a c√≥ m√≥n n√†o</div>
        </div>

        <div style="padding: 15px; border-top: 2px solid #ddd;">
            <div
                style="display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; margin-bottom: 15px;">
                <span>T·ªïng c·ªông:</span>
                <span id="lbl-ordered-total" style="color: #dc3545;">0ƒë</span>
            </div>
            <button id="btn-submit-order" class="btn btn-primary" onclick="submitOrder()" disabled
                style="opacity: 0.5;">G·ª¨I TH·ª∞C ƒê∆†N</button>
        </div>
    </div>

    <!-- ========== TAB 2: M√ìN ƒê√É X√ÅC NH·∫¨N ========== -->
    <div id="panel-confirmed" class="tab-panel">
        <div id="confirmed-items" style="padding: 15px; min-height: 200px;">
            <div class="empty-state">Ch∆∞a g·ª≠i b·∫øp</div>
        </div>

        <div style="padding: 15px; border-top: 2px solid #ddd;">
            <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 18px;">
                <span>T·ªïng c·ªông:</span>
                <span id="lbl-confirmed-total" style="color: #dc3545;">0ƒë</span>
            </div>
        </div>
    </div>

    <!-- ========== MODAL: CH·ªåN M√ìN ========== -->
    <div id="modal-menu" class="modal d-none">
        <div class="modal-content">
            <!-- Header Modal -->
            <div
                style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #ddd;">
                <h3 style="margin: 0;">Ch·ªçn M√≥n</h3>
                <button onclick="closeMenuModal()"
                    style="background: none; border: none; font-size: 24px; cursor: pointer;">‚úï</button>
            </div>

            <!-- Search Bar -->
            <div style="padding: 15px;">
                <input type="text" id="search-input" placeholder="T√¨m ki·∫øm m√≥n..." class="search-input"
                    onkeyup="filterDishes()">
            </div>

            <!-- Category Filter -->
            <div id="category-filter" style="display: flex; gap: 8px; padding: 0 15px 15px; overflow-x: auto;">
                <button class="category-btn active" onclick="filterByCategory('all')">T·∫•t c·∫£</button>
            </div>

            <!-- Dish List -->
            <div id="dish-list" style="padding: 0 15px 100px; max-height: 400px; overflow-y: auto;">
                <div class="empty-state">ƒêang t·∫£i...</div>
            </div>

            <!-- Bottom Button -->
            <div
                style="position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; border-top: 2px solid #ddd;">
                <button id="btn-confirm-selection" class="btn btn-primary" onclick="confirmDishSelection()" disabled
                    style="opacity: 0.5;">CH·ªåN <span id="selected-count">0</span> H√ÄNG H√ìA</button>
            </div>
        </div>
    </div>

    <!-- ========== MODAL: CHI TI·∫æT M√ìN (CH·ªàNH S·ª¨A S·ªê L∆Ø·ª¢NG) ========== -->
    <div id="modal-dish-detail" class="modal d-none">
        <div class="modal-content" style="max-width: 90%; margin: auto;">
            <!-- Header -->
            <div
                style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #ddd;">
                <h3 id="detail-dish-name" style="margin: 0;">T√™n M√≥n</h3>
                <button onclick="closeDishDetailModal()"
                    style="background: none; border: none; font-size: 24px; cursor: pointer;">‚úï</button>
            </div>

            <!-- Content -->
            <div style="padding: 20px; text-align: center;">
                <div id="detail-dish-price"
                    style="font-size: 18px; color: #28a745; font-weight: bold; margin-bottom: 20px;">0ƒë</div>

                <!-- Quantity Control -->
                <div
                    style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 30px;">
                    <button onclick="decreaseQuantity()" class="qty-btn">‚àí</button>
                    <input type="number" id="detail-quantity" min="1" value="1" class="qty-input"
                        onchange="validateQuantity()">
                    <button onclick="increaseQuantity()" class="qty-btn">+</button>
                </div>

                <!-- Notes -->
                <div style="margin-bottom: 20px;">
                    <textarea id="detail-note" placeholder="Ghi ch√∫ (n·∫øu c√≥)" class="note-input" rows="3"></textarea>
                </div>

                <!-- Confirm Button -->
                <button onclick="addToCart()" class="btn btn-primary">TH√äM V√ÄO GI·ªé</button>
            </div>
        </div>
    </div>

    <!-- ========== SCRIPT ========== -->
    <script>
        // ===== STATE & CONFIG =====
        const urlParams = new URLSearchParams(window.location.search);
        const tableId = parseInt(urlParams.get('id'));
        const tableName = urlParams.get('name');
        const user = JSON.parse(localStorage.getItem('currentUser'));

        if (!user || !tableId) {
            window.location.href = '/pos.html';
        }

        document.getElementById('table-name').innerText = tableName;

        let allDishes = [];
        let allCategories = [];
        let cart = []; // { dishId, dishName, quantity, price, note }
        let currentDishDetail = null;
        let currentFilter = 'all';

        // ===== INITIALIZATION =====
        async function init() {
            await loadMenu();
            await loadCurrentOrder();

            // Auto refresh order every 3 seconds (ch·ªâ khi user kh√¥ng ƒëang ch·ªçn m√≥n)
            setInterval(() => {
                const modalMenu = document.getElementById('modal-menu');
                const modalDishDetail = document.getElementById('modal-dish-detail');

                // Refresh n·∫øu:
                // 1. Modal menu kh√¥ng m·ªü (user kh√¥ng ƒëang ch·ªçn m√≥n)
                // 2. Modal dish detail kh√¥ng m·ªü (user kh√¥ng ƒëang ch·ªânh s·ª≠a s·ªë l∆∞·ª£ng)
                if (modalMenu && modalMenu.classList.contains('d-none') &&
                    modalDishDetail && modalDishDetail.classList.contains('d-none')) {
                    loadCurrentOrder();
                }
            }, 3000);
        }

        // ===== LOAD MENU =====
        async function loadMenu() {
            try {
                const res = await fetch('/api/dish');
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                allDishes = await res.json();
                console.log('Loaded dishes:', allDishes);

                // Extract categories
                const categorySet = new Set();
                allDishes.forEach(d => {
                    if (d.category && d.category.categoryName) {
                        categorySet.add(JSON.stringify({
                            categoryID: d.category.categoryID,
                            categoryName: d.category.categoryName
                        }));
                    }
                });

                allCategories = Array.from(categorySet).map(c => JSON.parse(c));
                console.log('Categories:', allCategories);
                renderCategoryFilter();
                filterDishes(); // Render initial dish list
            } catch (err) {
                console.error('Error loading menu:', err);
                document.getElementById('dish-list').innerHTML = '<div class="empty-state">L·ªói t·∫£i menu: ' + err.message + '</div>';
            }
        }

        // ===== RENDER CATEGORY FILTER =====
        function renderCategoryFilter() {
            const container = document.getElementById('category-filter');
            container.innerHTML = '<button class="category-btn active" data-category-id="all" onclick="filterByCategory(\'all\')">T·∫•t c·∫£</button>';

            allCategories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.setAttribute('data-category-id', cat.categoryID);
                btn.textContent = cat.categoryName;
                btn.onclick = () => filterByCategory(cat.categoryID);
                container.appendChild(btn);
            });
        }

        // ===== FILTER DISHES BY CATEGORY & SEARCH =====
        function filterDishes() {
            const searchText = document.getElementById('search-input').value.toLowerCase();
            let filtered = allDishes;

            // Filter by category
            if (currentFilter !== 'all') {
                filtered = filtered.filter(d =>
                    d.category && d.category.categoryID === parseInt(currentFilter)
                );
            }

            // Filter by search text
            if (searchText) {
                filtered = filtered.filter(d =>
                    d.dishName.toLowerCase().includes(searchText)
                );
            }

            renderDishList(filtered);
        }

        // ===== FILTER BY CATEGORY =====
        function filterByCategory(categoryId) {
            currentFilter = categoryId;

            // Update button styles
            document.querySelectorAll('.category-btn').forEach(btn => {
                const btnText = btn.textContent.trim();
                const btnCategoryId = btnText === 'T·∫•t c·∫£' ? 'all' : btnText;

                if ((categoryId === 'all' && btnText === 'T·∫•t c·∫£') ||
                    (categoryId !== 'all' && btn.getAttribute('data-category-id') == categoryId)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            filterDishes();
        }

        // ===== RENDER DISH LIST =====
        function renderDishList(dishes) {
            const container = document.getElementById('dish-list');

            if (dishes.length === 0) {
                container.innerHTML = '<div class="empty-state">Kh√¥ng t√¨m th·∫•y m√≥n n√†o</div>';
                return;
            }

            let html = '';
            dishes.forEach(dish => {
                const isInCart = cart.some(item => item.dishId === dish.dishID);
                const cartItem = cart.find(item => item.dishId === dish.dishID);
                const qtyBadge = cartItem ? `<span class="qty-badge">${cartItem.quantity}</span>` : '';

                html += `
                    <div class="dish-card ${isInCart ? 'in-cart' : ''}" onclick="openDishDetail(${dish.dishID}, '${dish.dishName}', ${dish.price})">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 5px;">${dish.dishName}</div>
                            <div style="color: #28a745; font-weight: bold;">${(dish.price || 0).toLocaleString()}ƒë</div>
                        </div>
                        ${qtyBadge}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ===== OPEN DISH DETAIL MODAL =====
        function openDishDetail(dishId, dishName, price) {
            currentDishDetail = { dishId, dishName, price };

            // Check if already in cart
            const inCart = cart.find(item => item.dishId === dishId);
            const qty = inCart ? inCart.quantity : 1;
            const note = inCart ? inCart.note : '';

            document.getElementById('detail-dish-name').textContent = dishName;
            document.getElementById('detail-dish-price').textContent = price.toLocaleString() + 'ƒë';
            document.getElementById('detail-quantity').value = qty;
            document.getElementById('detail-note').value = note;

            document.getElementById('modal-dish-detail').classList.remove('d-none');
            document.body.style.overflow = 'hidden';
        }

        // ===== CLOSE DISH DETAIL MODAL =====
        function closeDishDetailModal() {
            document.getElementById('modal-dish-detail').classList.add('d-none');
            document.body.style.overflow = 'auto';
            currentDishDetail = null;
        }

        // ===== QUANTITY CONTROLS =====
        function increaseQuantity() {
            const input = document.getElementById('detail-quantity');
            input.value = parseInt(input.value) + 1;
        }

        function decreaseQuantity() {
            const input = document.getElementById('detail-quantity');
            if (parseInt(input.value) > 1) {
                input.value = parseInt(input.value) - 1;
            }
        }

        function validateQuantity() {
            const input = document.getElementById('detail-quantity');
            if (input.value < 1) input.value = 1;
        }

        // ===== ADD TO CART =====
        function addToCart() {
            if (!currentDishDetail) return;

            const quantity = parseInt(document.getElementById('detail-quantity').value);
            const note = document.getElementById('detail-note').value;

            // Check if already in cart
            const existingIndex = cart.findIndex(item => item.dishId === currentDishDetail.dishId);

            if (existingIndex >= 0) {
                // Update existing item
                cart[existingIndex].quantity = quantity;
                cart[existingIndex].note = note;
            } else {
                // Add new item
                cart.push({
                    dishId: currentDishDetail.dishId,
                    dishName: currentDishDetail.dishName,
                    quantity: quantity,
                    price: currentDishDetail.price,
                    note: note
                });
            }

            // Update UI
            updateSelectedCount();
            filterDishes(); // Re-render to show quantity badges
            closeDishDetailModal();
        }

        // ===== UPDATE SELECTED COUNT =====
        function updateSelectedCount() {
            const totalQty = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('selected-count').textContent = totalQty;
            document.getElementById('btn-confirm-selection').disabled = totalQty === 0;
            document.getElementById('btn-confirm-selection').style.opacity = totalQty === 0 ? '0.5' : '1';
        }

        // ===== OPEN MENU MODAL =====
        async function openMenuModal() {
            document.getElementById('modal-menu').classList.remove('d-none');
            document.body.style.overflow = 'hidden';
            await loadMenu(); // Reload menu m·ªói l·∫ßn m·ªü modal ƒë·ªÉ l·∫•y categories m·ªõi
            filterDishes(); // Show current cart state
        }

        // ===== CLOSE MENU MODAL =====
        function closeMenuModal() {
            document.getElementById('modal-menu').classList.add('d-none');
            document.body.style.overflow = 'auto';
        }

        // ===== CONFIRM DISH SELECTION =====
        function confirmDishSelection() {
            closeMenuModal();
            switchTab('ordered');
            renderOrderedItems();
        }

        // ===== RENDER ORDERED ITEMS (TAB 1) =====
        function renderOrderedItems() {
            const container = document.getElementById('ordered-items');

            if (cart.length === 0) {
                container.innerHTML = '<div class="empty-state">Ch∆∞a ch·ªçn m√≥n n√†o</div>';
                document.getElementById('lbl-ordered-total').textContent = '0ƒë';
                return;
            }

            let html = '';
            let total = 0;

            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;

                html += `
                    <div class="order-item">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 5px;">${item.dishName}</div>
                            <div style="color: #666; font-size: 13px;">
                                ${item.quantity} x ${item.price.toLocaleString()}ƒë
                            </div>
                            ${item.note ? `<small style="color: #ff9800;">(${item.note})</small>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; margin-bottom: 8px;">${itemTotal.toLocaleString()}ƒë</div>
                            <button onclick="removeFromCart(${item.dishId})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">X√≥a</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            document.getElementById('lbl-ordered-total').textContent = total.toLocaleString() + 'ƒë';

            // Enable submit button
            document.getElementById('btn-submit-order').disabled = false;
            document.getElementById('btn-submit-order').style.opacity = '1';
        }

        // ===== REMOVE FROM CART =====
        function removeFromCart(dishId) {
            cart = cart.filter(item => item.dishId !== dishId);
            updateSelectedCount();
            renderOrderedItems();
            filterDishes(); // Update quantity badges
        }

        // ===== SUBMIT ORDER =====
        async function submitOrder() {
            if (cart.length === 0) {
                alert('Ch∆∞a ch·ªçn m√≥n n√†o!');
                return;
            }

            const orderDetails = cart.map(item => ({
                dishID: item.dishId,
                quantity: item.quantity,
                note: item.note || ''
            }));

            console.log('Submitting order:', { details: orderDetails });

            try {
                const res = await fetch(`/api/order/${tableId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ details: orderDetails })
                });

                console.log('Submit response status:', res.status);
                const responseData = await res.json();
                console.log('Submit response:', responseData);

                if (res.ok) {
                    cart = []; // Clear cart
                    updateSelectedCount();
                    switchTab('confirmed');
                    await loadCurrentOrder();
                } else {
                    alert('L·ªói khi g·ª≠i ƒë∆°n h√†ng! ' + (responseData.message || ''));
                }
            } catch (err) {
                console.error('Error submitting order:', err);
                alert('L·ªói k·∫øt n·ªëi! ' + err.message);
            }
        }

        // ===== LOAD CURRENT ORDER =====
        async function loadCurrentOrder() {
            try {
                const res = await fetch(`/api/order/${tableId}`);
                console.log('‚è±Ô∏è [loadCurrentOrder] G·ªçi API, status:', res.status);

                if (res.status === 404) {
                    // Table has no order
                    console.log('‚ùå Kh√¥ng c√≥ ƒë∆°n h√†ng cho b√†n n√†y');
                    document.getElementById('ordered-items').innerHTML = '<div class="empty-state">Ch∆∞a c√≥ m√≥n n√†o</div>';
                    document.getElementById('lbl-ordered-total').textContent = '0ƒë';
                    document.getElementById('confirmed-items').innerHTML = '<div class="empty-state">Ch∆∞a g·ª≠i b·∫øp</div>';
                    document.getElementById('lbl-confirmed-total').textContent = '0ƒë';
                    return;
                }

                const orderData = await res.json();
                console.log('üì¶ [loadCurrentOrder] D·ªØ li·ªáu t·ª´ API:', orderData);
                console.log('üìã Chi ti·∫øt ƒë∆°n h√†ng:', orderData.details);

                // Split items into "New" and "Sent"
                const newItems = orderData.details ? orderData.details.filter(d => d.itemStatus === 'New') : [];
                const sentItems = orderData.details ? orderData.details.filter(d => d.itemStatus === 'Sent') : [];

                console.log('üü° Items M·ªõi (Tab 1):', newItems.length, newItems);
                console.log('üü¢ Items ƒê√£ G·ª≠i (Tab 2):', sentItems.length, sentItems);

                // Calculate totals
                const newItemsTotal = newItems.reduce((sum, item) => sum + item.totalAmount, 0);
                const sentItemsTotal = sentItems.reduce((sum, item) => sum + item.totalAmount, 0);

                console.log('New items total:', newItemsTotal);
                console.log('Sent items total:', sentItemsTotal);

                // Render Tab 1: Ordered (New items)
                renderTab1Items(newItems, newItemsTotal);

                // Render Tab 2: Confirmed (Sent items)
                renderTab2Items(sentItems, sentItemsTotal);

            } catch (err) {
                console.error('Error loading order:', err);
            }
        }

        // ===== RENDER TAB 1: ORDERED ITEMS (FROM SERVER "New" + LOCAL CART) =====
        function renderTab1Items(serverNewItems, totalAmount) {
            const container = document.getElementById('ordered-items');
            console.log('renderTab1Items called with serverNewItems:', serverNewItems, 'cart:', cart);

            // K·∫øt h·ª£p items "New" t·ª´ server + items t·ª´ local cart
            let allItems = [];

            // Th√™m items t·ª´ local cart
            cart.forEach(item => {
                allItems.push({
                    dishName: item.dishName,
                    quantity: item.quantity,
                    unitPrice: item.price,
                    totalAmount: item.price * item.quantity,
                    note: item.note,
                    source: 'cart'
                });
            });

            // Th√™m items "New" t·ª´ server
            serverNewItems.forEach(item => {
                allItems.push({
                    dishName: item.dishName,
                    quantity: item.quantity,
                    unitPrice: item.unitPrice,
                    totalAmount: item.totalAmount,
                    note: item.note,
                    source: 'server'
                });
            });

            console.log('Tab 1 allItems after merge:', allItems);

            if (allItems.length === 0) {
                container.innerHTML = '<div class="empty-state">Ch∆∞a c√≥ m√≥n n√†o</div>';
                document.getElementById('lbl-ordered-total').textContent = '0ƒë';
                document.getElementById('btn-submit-order').disabled = true;
                document.getElementById('btn-submit-order').style.opacity = '0.5';
                return;
            }

            let html = '';
            let total = 0;

            allItems.forEach(item => {
                total += item.totalAmount;

                html += `
                    <div class="order-item">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 5px;">${item.dishName}</div>
                            <div style="color: #666; font-size: 13px;">
                                ${item.quantity} x ${item.unitPrice.toLocaleString()}ƒë
                            </div>
                            ${item.note ? `<small style="color: #ff9800;">(${item.note})</small>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold;">${item.totalAmount.toLocaleString()}ƒë</div>
                            <span style="display: inline-block; background: #ffc107; color: #333; padding: 3px 8px; border-radius: 3px; font-size: 11px; margin-top: 5px;">Ch·ªù g·ª≠i</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            document.getElementById('lbl-ordered-total').textContent = total.toLocaleString() + 'ƒë';

            // Enable submit button n·∫øu c√≥ items
            document.getElementById('btn-submit-order').disabled = allItems.length === 0;
            document.getElementById('btn-submit-order').style.opacity = allItems.length === 0 ? '0.5' : '1';
            console.log('Tab 1 rendered, total items:', allItems.length);
        }

        // ===== RENDER TAB 2: CONFIRMED ITEMS (SENT) =====
        function renderTab2Items(items, totalAmount) {
            const container = document.getElementById('confirmed-items');
            console.log('üü¢ [renderTab2Items] S·ªë l∆∞·ª£ng items:', items.length, 'Items:', items);

            if (items.length === 0) {
                console.log('‚ÑπÔ∏è Kh√¥ng c√≥ m√≥n n√†o, hi·ªÉn th·ªã empty state');
                container.innerHTML = '<div class="empty-state">Ch∆∞a g·ª≠i b·∫øp</div>';
                document.getElementById('lbl-confirmed-total').textContent = '0ƒë';
                return;
            }

            let html = '';
            items.forEach((item, index) => {
                console.log(`  Item ${index}: ${item.dishName}, qty=${item.quantity}, status=${item.itemStatus}`);
                html += `
                    <div class="order-item">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 5px;">${item.dishName}</div>
                            <div style="color: #666; font-size: 13px;">
                                ${item.quantity} x ${item.unitPrice.toLocaleString()}ƒë
                            </div>
                            ${item.note ? `<small style="color: #ff9800;">(${item.note})</small>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold;">${item.totalAmount.toLocaleString()}ƒë</div>
                            <span style="display: inline-block; background: #28a745; color: white; padding: 3px 8px; border-radius: 3px; font-size: 11px; margin-top: 5px;">ƒê√£ g·ª≠i</span>
                        </div>
                    </div>
                `;
            });

            console.log('Final HTML to render:', html);
            container.innerHTML = html;
            document.getElementById('lbl-confirmed-total').textContent = totalAmount.toLocaleString() + 'ƒë';
            console.log('Tab 2 rendered successfully');
        }

        // ===== SWITCH TAB =====
        function switchTab(tabName) {
            if (tabName === 'ordered') {
                document.getElementById('panel-ordered').classList.add('active');
                document.getElementById('panel-confirmed').classList.remove('active');
                document.getElementById('tab-ordered').classList.add('active');
                document.getElementById('tab-confirmed').classList.remove('active');
            } else {
                document.getElementById('panel-ordered').classList.remove('active');
                document.getElementById('panel-confirmed').classList.add('active');
                document.getElementById('tab-ordered').classList.remove('active');
                document.getElementById('tab-confirmed').classList.add('active');
            }
        }

        // ===== GO BACK TO TABLES =====
        function goBackToTables() {
            window.location.href = '/pos.html';
        }

        // ===== INIT ON LOAD =====
        window.addEventListener('load', init);
    </script>

    <!-- N·∫°p th∆∞ vi·ªán SignalR -->
    <script src="js/signalr.min.js"></script>

    <script>
        // --- C·∫§U H√åNH REALTIME ---
        // Ki·ªÉm tra xem signalr c√≥ ƒë∆∞·ª£c load kh√¥ng
        if (typeof signalr !== 'undefined') {
            const connection = new signalr.HubConnectionBuilder()
                .withUrl("/posHub")
                .withAutomaticReconnect()
                .build();

            // L·∫Øng nghe s·ª± ki·ªán t·ª´ Server (ALWAYS update, kh√¥ng check modal)
            connection.on("TableUpdated", (updatedTableId) => {
                if (updatedTableId === tableId) {
                    console.log("üîÑ SignalR: ƒê∆°n b√†n " + updatedTableId + " v·ª´a c·∫≠p nh·∫≠t t·ª´ PC!");
                    loadCurrentOrder();  // Lu√¥n load ngay, kh√¥ng check modal
                }
            });

            // B·∫Øt ƒë·∫ßu k·∫øt n·ªëi
            connection.start().catch(err => console.error('SignalR connection error:', err));
        } else {
            console.warn('SignalR library not loaded');
        }

        // Auto-refresh n·∫øu kh√¥ng trong modal (3 gi√¢y)
        setInterval(() => {
            const modalMenu = document.getElementById('modal-menu');
            const modalDishDetail = document.getElementById('modal-dish-detail');

            if (modalMenu && modalMenu.classList.contains('d-none') &&
                modalDishDetail && modalDishDetail.classList.contains('d-none')) {
                loadCurrentOrder();
            }
        }, 3000);

        // Kh·ªüi ch·∫°y ·ª©ng d·ª•ng
        init();
    </script>
</body>

</html>