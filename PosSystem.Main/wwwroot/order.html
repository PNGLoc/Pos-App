<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chi ti·∫øt b√†n</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- 1. HEADER -->
    <div class="header">
        <button onclick="window.location.href='/pos.html'"
            style="background:none; border:none; color:white; font-size:20px;">‚¨Ö</button>
        <span id="table-name" style="font-weight:bold; font-size:18px;">B√†n ...</span>
        <button onclick="loadCurrentOrder()" style="background:none; border:none; color:white;">üîÑ</button>
    </div>

    <!-- 2. NAV SEGMENT (TAB CHUY·ªÇN ƒê·ªîI) -->
    <div class="nav-segment">
        <div id="btn-tab-1" class="segment-btn active" onclick="switchTab(1)">ƒê√£ g·ªçi</div>
        <div id="btn-tab-2" class="segment-btn" onclick="switchTab(2)">G·ªçi m√≥n</div>
    </div>

    <!-- 3. VIEW 1: DANH S√ÅCH M√ìN ƒê√É G·ªåI -->
    <div id="view-ordered" class="ordered-list">
        <div id="ordered-items-container">Loading...</div>

        <div style="margin-top: 20px; border-top: 2px dashed #ddd; padding-top: 10px;">
            <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:18px;">
                <span>T·ªïng c·ªông:</span>
                <span id="lbl-total-amount" style="color:red;">0ƒë</span>
            </div>
            <!-- N√∫t thanh to√°n t·∫°m th·ªùi ·∫©n, ch·ªâ hi·ªán tr√™n m√°y PC thu ng√¢n -->
            <p style="text-align:center; color:#888; font-size:12px; margin-top:10px;">
                (Vui l√≤ng li√™n h·ªá thu ng√¢n ƒë·ªÉ thanh to√°n)
            </p>
        </div>
    </div>

    <!-- 4. VIEW 2: MENU G·ªåI M√ìN (·∫®n m·∫∑c ƒë·ªãnh) -->
    <div id="view-menu" class="d-none">
        <!-- Danh s√°ch nh√≥m -->
        <div id="category-list" class="menu-tabs"></div>
        <!-- Danh s√°ch m√≥n -->
        <div id="dish-list" class="dish-grid" style="padding-bottom: 80px;"></div>

        <!-- Gi·ªè h√†ng n·ªïi -->
        <div class="cart-floating">
            <div>
                <div>T·∫°m t√≠nh:</div>
                <div id="total-price-cart" class="cart-total">0ƒë</div>
            </div>
            <button class="btn btn-order" onclick="submitOrder()">G·ª¨I B·∫æP (<span id="cart-count">0</span>)</button>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const urlParams = new URLSearchParams(window.location.search);
        const tableId = parseInt(urlParams.get('id'));
        const tableName = urlParams.get('name');
        const user = JSON.parse(localStorage.getItem('currentUser'));

        if (!user || !tableId) window.location.href = '/pos.html';
        document.getElementById('table-name').innerText = tableName;

        let fullMenu = [];
        let cart = [];

        // --- CORE FUNCTIONS ---

        // 1. H√†m kh·ªüi ch·∫°y
        async function init() {
            // T·∫£i menu tr∆∞·ªõc (ƒë·ªÉ s·∫µn s√†ng cho tab G·ªçi m√≥n)
            await loadMenu();
            // T·∫£i ƒë∆°n h√†ng hi·ªán t·∫°i c·ªßa b√†n
            await loadCurrentOrder();
        }

        // 2. Chuy·ªÉn Tab
        function switchTab(tabIndex) {
            if (tabIndex === 1) {
                document.getElementById('view-ordered').classList.remove('d-none');
                document.getElementById('view-menu').classList.add('d-none');
                document.getElementById('btn-tab-1').classList.add('active');
                document.getElementById('btn-tab-2').classList.remove('active');
                loadCurrentOrder(); // Reload l·∫°i cho ch·∫Øc
            } else {
                document.getElementById('view-ordered').classList.add('d-none');
                document.getElementById('view-menu').classList.remove('d-none');
                document.getElementById('btn-tab-1').classList.remove('active');
                document.getElementById('btn-tab-2').classList.add('active');
            }
        }

        // 3. T·∫£i ƒë∆°n ƒë√£ g·ªçi (QUAN TR·ªåNG)
        async function loadCurrentOrder() {
            const container = document.getElementById('ordered-items-container');
            const lblTotal = document.getElementById('lbl-total-amount');

            try {
                const res = await fetch(`/api/order/${tableId}`);

                if (res.status === 404) {
                    // N·∫øu b√†n tr·ªëng (404) -> T·ª± ƒë·ªông chuy·ªÉn sang Tab G·ªçi m√≥n
                    container.innerHTML = '<div class="empty-state">B√†n ch∆∞a c√≥ m√≥n n√†o<br>Vui l√≤ng chuy·ªÉn sang Tab "G·ªçi m√≥n"</div>';
                    lblTotal.innerText = '0ƒë';

                    // Logic t·ª± ƒë·ªông chuy·ªÉn tab n·∫øu b√†n tr·ªëng
                    // Ch·ªâ chuy·ªÉn l·∫ßn ƒë·∫ßu, tr√°nh chuy·ªÉn khi ng∆∞·ªùi d√πng ƒëang xem
                    if (document.getElementById('view-ordered').classList.contains('d-none') == false) {
                        switchTab(2);
                    }
                    return;
                }

                const orderData = await res.json();

                // Render danh s√°ch
                if (orderData.details && orderData.details.length > 0) {
                    let html = '';
                    orderData.details.forEach(d => {
                        html += `
                        <div class="order-item">
                            <div>
                                <div style="font-weight:bold;">${d.dishName}</div>
                                <div style="color:#666; font-size:13px;">
                                    ${d.quantity} x ${d.unitPrice.toLocaleString()}ƒë
                                </div>
                                ${d.note ? `<small style="color:orange">(${d.note})</small>` : ''}
                            </div>
                            <div style="text-align:right;">
                                <div style="font-weight:bold;">${d.totalAmount.toLocaleString()}ƒë</div>
                                <span class="item-badge ${d.itemStatus === 'New' ? 'status-new' : 'status-sent'}">
                                    ${d.itemStatus === 'New' ? 'M·ªõi g·ªçi' : 'ƒê√£ g·ª≠i'}
                                </span>
                            </div>
                        </div>`;
                    });
                    container.innerHTML = html;
                    lblTotal.innerText = orderData.finalAmount.toLocaleString() + 'ƒë';
                } else {
                    container.innerHTML = '<div class="empty-state">ƒê∆°n r·ªóng</div>';
                }

            } catch (err) {
                container.innerText = "L·ªói k·∫øt n·ªëi!";
            }
        }

        // 4. C√°c h√†m Menu & Cart (Gi·ªØ nguy√™n logic c≈©)
        async function loadMenu() {
            try {
                const res = await fetch('/api/menu');
                fullMenu = await res.json();
                renderCategories();
                if (fullMenu.length > 0) renderDishes(0); // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã "T·∫•t c·∫£"
            } catch (e) { console.error(e); }
        }

        function renderCategories() {
            const container = document.getElementById('category-list');

            // 1. Lu√¥n th√™m n√∫t "T·∫•t c·∫£" ƒë·∫ßu ti√™n v·ªõi ID = 0
            let html = `
        <div class="tab-item active" onclick="renderDishes(0, this)">
            T·∫•t c·∫£
        </div>
    `;

            // 2. Map c√°c category t·ª´ API
            html += fullMenu.map((cat) => `
        <div class="tab-item" onclick="renderDishes(${cat.categoryID}, this)">
            ${cat.categoryName}
        </div>
    `).join('');

            container.innerHTML = html;

            // M·∫∑c ƒë·ªãnh load m√≥n c·ªßa "T·∫•t c·∫£" ngay l·∫ßn ƒë·∫ßu
            renderDishes(0);
        }

        function renderDishes(catId, element) {
            // X·ª≠ l√Ω hi·ªáu ·ª©ng Active cho tab
            if (element) {
                document.querySelectorAll('.tab-item').forEach(e => e.classList.remove('active'));
                element.classList.add('active');
            }

            const container = document.getElementById('dish-list');
            let dishesToShow = [];

            if (catId === 0) {
                // N·∫øu l√† 0: L·∫•y t·∫•t c·∫£ m√≥n t·ª´ t·∫•t c·∫£ nh√≥m
                fullMenu.forEach(cat => {
                    if (cat.dishes) dishesToShow = dishesToShow.concat(cat.dishes);
                });
            } else {
                // T√¨m nh√≥m t∆∞∆°ng ·ª©ng
                const category = fullMenu.find(c => c.categoryID === catId);
                dishesToShow = category ? category.dishes : [];
            }

            if (dishesToShow.length === 0) {
                container.innerHTML = '<div style="text-align:center; margin-top:20px; color:#888;">Kh√¥ng c√≥ m√≥n n√†o</div>';
                return;
            }

            container.innerHTML = dishesToShow.map(d => `
        <div class="dish-card" onclick="addToCart(${d.dishID}, '${d.dishName}', ${d.price})">
            <img src="/images/${d.imagePath}" onerror="this.src='https://placehold.co/150'" class="dish-img">
            <div class="dish-info">
                <div class="dish-name">${d.dishName}</div>
                <div class="dish-price">${d.price.toLocaleString()}ƒë</div>
            </div>
        </div>
    `).join('');
        }

        function addToCart(id, name, price) {
            if (navigator.vibrate) navigator.vibrate(50);
            const existItem = cart.find(i => i.dishId === id);
            if (existItem) existItem.quantity++;
            else cart.push({ dishId: id, name: name, price: price, quantity: 1 });
            updateCartUI();
        }

        function updateCartUI() {
            const count = cart.reduce((sum, i) => sum + i.quantity, 0);
            const total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
            document.getElementById('cart-count').innerText = count;
            document.getElementById('total-price-cart').innerText = total.toLocaleString() + 'ƒë';
        }

        async function submitOrder() {
            if (cart.length === 0) return alert("Ch∆∞a ch·ªçn m√≥n n√†o!");
            if (!confirm(`G·ª≠i ${cart.length} m√≥n xu·ªëng b·∫øp?`)) return;

            const payload = {
                tableID: tableId,
                accID: user.accID,
                items: cart.map(i => ({ dishID: i.dishId, quantity: i.quantity, note: "" }))
            };

            try {
                const res = await fetch('/api/order/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    // G·ª≠i xong th√¨: 
                    // 1. X√≥a gi·ªè
                    cart = []; updateCartUI();
                    // 2. Chuy·ªÉn ngay v·ªÅ tab "ƒê√£ g·ªçi" ƒë·ªÉ xem k·∫øt qu·∫£
                    alert("‚úÖ ƒê√£ g·ª≠i ƒë∆°n!");
                    switchTab(1);
                } else {
                    alert("L·ªói server: " + await res.text());
                }
            } catch (e) { alert("M·∫•t k·∫øt n·ªëi!"); }
        }

        // --- RUN ---
        init();

    </script>
</body>

</html>